<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>å…¥è· Day-1 RPGï¼ˆå…¬å¸åœ’å€ï¼‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  :root{
    --ink:#0b0e11; --muted:#6b7280; --panel:#ffffff; --line:#e5e7eb; --brand:#1976d2;
  }
  html,body{height:100%; margin:0; background:#0b0e11; color:#111; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  .wrap{max-width:1120px;margin:0 auto;padding:12px; display:grid; grid-template-columns: 760px 1fr; gap:12px;}
  #game{display:block; width:760px; height:520px; image-rendering: pixelated; border:2px solid #222; background:#000; border-radius:10px}
  .panel{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px}
  .hbar{display:flex;align-items:center;justify-content:space-between;margin:8px auto 0;max-width:1120px;color:#fff}
  .hbar .title{font-weight:800;font-size:18px}
  .hud{color:#cbd5e1;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .hud .dot{width:10px;height:10px;border-radius:50%;background:#22c55e;display:inline-block;margin-right:6px}

  .side h3{margin:0 0 6px}
  .quest{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
  .quest li{border:1px solid var(--line);border-radius:8px;padding:8px}
  .quest small{color:var(--muted)}
  .done{color:#22c55e;font-weight:700}

  .dialog{position:absolute;left:50%;bottom:24px;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;
          border:1px solid #333;border-radius:10px;padding:10px 12px;max-width:820px;backdrop-filter: blur(3px);}
  .dialog .k{display:inline-block;padding:0 6px;border:1px solid #fff;border-radius:6px;margin:0 4px}

  .photo{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);z-index:30}
  .photo.active{display:grid}
  .photo .box{background:#fff;border-radius:12px;border:1px solid var(--line);width:min(920px,92vw);padding:10px}
  .photo img{width:100%;height:auto;border-radius:10px;border:1px solid var(--line);background:#f3f4f6}
  .photo .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .photo .head b{font-size:16px}
  .photo .x{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}

  .foot{color:#94a3b8;text-align:center;margin:8px 0 18px;font-size:12px}

  /* å³å´é¢æ¿è£¡çš„æ¬¡è¦æ–‡å­— */
  .hint-muted{color:#374151}
</style>
</head>
<body>
  <div class="hbar">
    <div class="title">å…¥è· Day-1 RPGï¼ˆå…¬å¸åœ’å€ï¼‰</div>
    <div class="hud">
      <span><span class="dot"></span>ç·šä¸Š</span>
      <span>ä»»å‹™å®Œæˆåº¦ï¼š<b id="pct">0%</b></span>
      <span>æç¤ºï¼šæ–¹å‘éµ/WASD ç§»å‹•ï¼Œ<b>E</b> æŸ¥çœ‹åœ°æ¨™ã€<b>Enter</b> ä¸‹ä¸€å¥ã€<b>N</b> æ—¥å¤œåˆ‡æ›ã€<b>R</b> å›åˆ°èµ·é»ã€‚</span>
    </div>
  </div>

  <div class="wrap">
    <div style="position:relative">
      <canvas id="game" width="760" height="520" aria-label="RPG åœ°åœ–"></canvas>
      <!-- å°è©± -->
      <div id="dlg" class="dialog" style="display:none"></div>
    </div>

    <aside class="side panel">
      <h3>Day-1 ä»»å‹™æ¸…å–®</h3>
      <ul id="qList" class="quest"></ul>
      <hr/>
      <h3>NPC æç¤º</h3>
      <div id="hint" class="hint-muted">è«‹å…ˆå‰å¾€ <b>IT è¨­å‚™æ«ƒå°</b> é ˜å–ç­†é›»èˆ‡é–‹é€šå¸³è™Ÿã€‚</div>
    </aside>
  </div>

  <!-- ç…§ç‰‡é¢æ¿ï¼ˆæ”¾çœŸå¯¦å ´æ™¯ï¼‰ -->
  <div id="photo" class="photo" role="dialog" aria-label="å ´æ™¯ç…§ç‰‡">
    <div class="box">
      <div class="head">
        <b id="phTitle">åœ°æ¨™</b>
        <button class="x" onclick="closePhoto()">âœ• é—œé–‰</button>
      </div>
      <img id="phImg" alt="åœ°æ¨™ç…§ç‰‡"/>
      <div id="phDesc" style="margin-top:6px;color:#374151"></div>
    </div>
  </div>

  <div class="foot">ï¼ é»‘å®¢æ¾æ¿çƒ¤è‚‰å‡ºç‰ˆ</div>

<script>
/* ================= åŸºæœ¬è¨­å®š ================= */
const cvs = document.getElementById('game'), ctx = cvs.getContext('2d');
const W = cvs.width, H = cvs.height;
const TILE = 32;                 // å–®ä¸€åœ–å¡Šå¤§å°
const VW = Math.floor(W / TILE); // è¢å¹•å¯è¦‹å¯¬ï¼ˆä»¥ tile è¨ˆï¼‰
const VH = Math.floor(H / TILE);
const SPEED = 2.2;               // ç§»å‹•é€Ÿåº¦ï¼ˆåƒç´ /frameï¼‰
const keys = {}; addEventListener('keydown',e=>keys[e.key]=true);
addEventListener('keyup',e=>keys[e.key]=false);

/* ================= åœ°åœ–ï¼ˆç´” JS tilesï¼‰ =================
   0:è‰åœ° 1:é“è·¯ 2:ç‰† 3:æ°´ 4:å»ºç¯‰åœ°æ¿
   åšä¸€å¼µ 60Ã—40 tiles çš„åœ’å€ï¼Œé¡é ­æœƒè·Ÿéš¨ç©å®¶æ²å‹•
*/
const MAP_W=60, MAP_H=40;
const map = new Array(MAP_H).fill(0).map(()=>new Array(MAP_W).fill(0));
// é“è·¯ç¶²
for(let y=6;y<MAP_H-6;y++) map[y][10]=1;
for(let x=10;x<MAP_W-8;x++) map[6][x]=1;
for(let x=6;x<MAP_W-12;x++) map[20][x]=1;
for(let y=8;y<MAP_H-8;y++) map[y][30]=1;
// å»ºç¯‰å€å¡Š & ç‰†
function rect(x0,y0,w,h,val){for(let y=y0;y<y0+h;y++)for(let x=x0;x<x0+w;x++) map[y][x]=val;}
rect(14,2,8,6,2);   rect(15,3,6,4,4);      // IT æ¬Šé™/è¨­å‚™å¤§æ¨“
rect(34,5,8,7,2);   rect(35,6,6,5,4);      // é–‹ç™¼ç’°å¢ƒå€
rect(22,18,8,6,2);  rect(23,19,6,4,4);     // ä¿å¥ä¸­å¿ƒ
rect(44,22,8,6,2);  rect(45,23,6,4,4);     // HR è¾¦å…¬å®¤
rect(8,26,8,6,2);   rect(9,27,6,4,4);      // å“¡å·¥é¤å»³

// === å°å·¥å…·ï¼šæŠŠ (x,y) æ”¹æˆå¯é€šè¡Œçš„é“è·¯ ===
function openAsRoad(x, y) { map[y][x] = 1; }

// 1) IT æ¬Šé™/è¨­å‚™å¤§æ¨“ (åº•é‚Šä¸­å¤®é–‹ä¸‰æ ¼é–€)
for (let x=17; x<=19; x++) {
  openAsRoad(x, 7);       // å¤–ç‰†ä¸‰æ ¼
}

// 2) é–‹ç™¼ç’°å¢ƒå€ (é ‚é‚Šä¸­å¤®é–‹ä¸‰æ ¼é–€)
for (let x=37; x<=39; x++) {
  openAsRoad(x, 5);
}

// 3) ä¿å¥ä¸­å¿ƒ (é ‚é‚Šä¸­å¤®é–‹ä¸‰æ ¼é–€)
for (let x=25; x<=27; x++) {
  openAsRoad(x, 18);
}

// 4) HR è¾¦å…¬å®¤ (é ‚é‚Šä¸­å¤®é–‹ä¸‰æ ¼é–€)
for (let x=47; x<=49; x++) {
  openAsRoad(x, 22);
}

// 5) å“¡å·¥é¤å»³ (å·¦é‚Šä¸­å¤®é–‹ä¸‰æ ¼é–€)
for (let y=27; y<=29; y++) {
  openAsRoad(8, y);
}

// æ°´åŸŸé‚Šç•Œ
for(let y=0;y<MAP_H;y++) map[y][0]=map[y][MAP_W-1]=3;
for(let x=0;x<MAP_W;x++) map[0][x]=map[MAP_H-1][x]=3;

/* ================= ç¢°æ’ ================= */
function isBlocked(tx,ty){
  if(tx<0||ty<0||tx>=MAP_W||ty>=MAP_H) return true;
  return map[ty][tx]===2 || map[ty][tx]===3;
}

/* ================= ä¸»è§’ï¼ˆå››å‘å‹•ç•«ï¼‰ ================= */
// åŠ è¼‰è§’è‰²ç²¾éˆåœ–
const playerImgUp = new Image();
const playerImgDown = new Image();
const playerImgLeft = new Image();
const playerImgRight = new Image();

playerImgUp.src = './playerUp.png';
playerImgDown.src = './playerDown.png';
playerImgLeft.src = './playerLeft.png';
playerImgRight.src = './playerRight.png';

// ç¢ºä¿åœ–ç‰‡è¼‰å…¥å®Œæˆå¾Œå†ä½¿ç”¨
const imagePromises = [
  new Promise(resolve => playerImgUp.onload = resolve),
  new Promise(resolve => playerImgDown.onload = resolve),
  new Promise(resolve => playerImgLeft.onload = resolve),
  new Promise(resolve => playerImgRight.onload = resolve)
];

// ç‚ºé˜²æ­¢åœ–ç‰‡è¼‰å…¥å¤±æ•—
playerImgUp.onerror = () => console.error("ç„¡æ³•è¼‰å…¥å‘ä¸Šè¡Œèµ°å‹•ç•«");
playerImgDown.onerror = () => console.error("ç„¡æ³•è¼‰å…¥å‘ä¸‹è¡Œèµ°å‹•ç•«");
playerImgLeft.onerror = () => console.error("ç„¡æ³•è¼‰å…¥å‘å·¦è¡Œèµ°å‹•ç•«");
playerImgRight.onerror = () => console.error("ç„¡æ³•è¼‰å…¥å‘å³è¡Œèµ°å‹•ç•«");

// æ›¿æ›åŸä¾†çš„spriteså°è±¡
const sprites = {
  up: playerImgUp,
  down: playerImgDown,
  left: playerImgLeft,
  right: playerImgRight
};

// åˆå§‹åŒ–ç©å®¶ç‹€æ…‹
const START = { x: 11, y: 6, name: '' };     // ä»¥ tile è¨ˆ
const player = { x: START.x*TILE+16, y: START.y*TILE+16, dir: 'down', f:0, tick:0, moving: false };

/* ================= POIï¼ˆç…§ç‰‡ / ä»»å‹™ / å°è©±ï¼‰ ================= */
const poi = [
  { id:'it',   name:'IT è¨­å‚™æ«ƒå°',  x:16, y:4,  photo:'./workplace.jpg',
    desc:'é ˜å–ç­†é›»ã€é–€ç¦å¡ã€é–‹é€š AD/Emailã€è¨­å®š MFAã€‚', talk:['æ­¡è¿å…¥è·ï¼å…ˆé ˜å–ç­†é›»èˆ‡é–‹é€šå¸³è™Ÿå§ã€‚','è¨˜å¾—æŠŠ VPN ä¹Ÿæ¸¬ä¸€ä¸‹ã€‚'],
    next:'è«‹å‰å¾€ã€ŒVPN æ¸¬è©¦é»ã€ã€‚ (x:12,y:6)' },
  { id:'vpn',  name:'VPN æ¸¬è©¦é»',  x:12, y:6,  photo:'./vpn_test.jpg',
    desc:'æ¸¬è©¦ VPN é€£ç·šã€å…§ç¶²å¯é”æ€§ã€‚', talk:['VPN é€£ä¸Šäº†å—ï¼Ÿè©¦ ping å…§ç¶²æœå‹™çœ‹çœ‹ã€‚'],
    next:'ä¸‹ä¸€æ­¥åˆ°ã€Œé–‹ç™¼ç’°å¢ƒå€ã€å®‰è£ IDE/Gitã€‚ (x:37,y:8)'},
  { id:'dev',  name:'é–‹ç™¼ç’°å¢ƒå€',  x:37, y:8,  photo:'./life_workplace_16_lg.jpg',
    desc:'å®‰è£ IDE / Git / Node / å…§éƒ¨ registryï¼›æ‹‰å°ˆæ¡ˆè©¦ç·¨è­¯ã€‚', talk:['IDE è£å¥½äº†å—ï¼Ÿ','å…ˆè·‘ä¸€å€‹ hello build è©¦è©¦ã€‚'],
    next:'å»ã€Œä¿å¥ä¸­å¿ƒã€å®Œæˆæ–°äººé«”æª¢ã€‚ (x:25,y:21)'},
     { id:'cafeteria', name:'å“¡å·¥é¤å»³', x:11, y:28, photo:'./cafeteria.jpg',
  desc:'æä¾›å¤šåœ‹æ–™ç†èˆ‡å¥åº·é¤ï¼Œæ”¯æ´å“¡å·¥å¡æ”¯ä»˜ï¼Œå»ºè­°éŒ¯å³°ç”¨é¤ã€‚',
  talk:['ä»Šå¤©çš„é¤é»å¾ˆè±å¯Œå–”ï¼','åˆé¤é«˜å³°æ™‚æ®µè¨˜å¾—é¿é–‹äººæ½®ã€‚'],
  next:'æ¥ä¸‹ä¾†è«‹å‰å¾€ã€Œä¿å¥ä¸­å¿ƒã€å®Œæˆæ–°äººé«”æª¢ã€‚ (x:25,y:21)'
    },
  { id:'clinic',name:'ä¿å¥ä¸­å¿ƒ',   x:25, y:21, photo:'./wellness.jpg',
    desc:'å¥åº·æª¢æŸ¥ã€ç·Šæ€¥å”åŠ©ã€å¿ƒç†è«®å•†è³‡æºã€‚', talk:['é‡è¡€å£“èˆ‡è¦–åŠ›åœ¨é€™é‚Šã€‚','èº«é«”ä¸é©å¯éš¨æ™‚ä¾†ã€‚'],
    next:'æœ€å¾Œå»ã€ŒHR è¾¦å…¬å®¤ã€ç¹³äº¤æ–‡ä»¶ã€‚ (x:48,y:25)'},
  { id:'hr',   name:'HR è¾¦å…¬å®¤',   x:48, y:25, photo:'./HR.jpg',
    desc:'å ±åˆ°æ–‡ä»¶èˆ‡ç¦åˆ©èªªæ˜ã€æ¬Šé™è£œä»¶ã€‚', talk:['æ­¡è¿åŠ å…¥ï¼','è¨˜å¾—å®Œæˆç·šä¸Šæ–°äººå°å‘èª²ç¨‹ã€‚'],
    next:'ğŸ‰ Day-1 å®Œæˆï¼Œæ­å–œï¼'}
];
const END = poi[poi.length-1];

const quests = [
    { id:'vpn',   title:'VPN æ¸¬è©¦',            done:false },
  { id:'it',    title:'é ˜å–è¨­å‚™èˆ‡é–‹é€šå¸³è™Ÿ',  done:false },
  { id:'dev',   title:'å®‰è£é–‹ç™¼ç’°å¢ƒ',        done:false },
  { id:'cafeteria', title:'å‰å¾€å“¡å·¥é¤å»³ç”¨é¤', done:false },
  { id:'clinic',title:'å®Œæˆå¥æª¢',            done:false },
  { id:'hr',    title:'HR æ–‡ä»¶ç¹³äº¤',        done:false },
];

function drawQuests(){
  const ul = document.getElementById('qList'); ul.innerHTML='';
  quests.forEach(q=>{
    const li = document.createElement('li');
    li.innerHTML = `<div>${q.done?`<span class="done">âœ”</span>`:'â¬œ'} ${q.title}</div>
                    <small>${q.done?'å·²å®Œæˆ':'å°šæœªå®Œæˆ'}</small>`;
    ul.appendChild(li);
  });
  const pct = Math.round(quests.filter(q=>q.done).length/quests.length*100);
  document.getElementById('pct').textContent = pct+'%';
}

/* ================= ç¹ªåœ–ï¼ˆtiles / é“è·¯ / ç©å®¶ / å°åœ°åœ–ï¼‰ ================= */
function drawTile(t, x, y){
  // åœŸåœ°è‰²èª¿ç•¥äº®ï¼Œè®“ç•«é¢ä¸æœƒå¤ªæš—
  if(t===0){ ctx.fillStyle='#2da26b'; }      // è‰
  if(t===1){ ctx.fillStyle='#b99c70'; }      // è·¯
  if(t===2){ ctx.fillStyle='#30343a'; }      // ç‰†ï¼ˆé˜»æ“‹ï¼‰
  if(t===3){ ctx.fillStyle='#2a4b8d'; }      // æ°´
  if(t===4){ ctx.fillStyle='#c7d2fe'; }      // å»ºç¯‰åœ°æ¿
  ctx.fillRect(x,y,TILE,TILE);
  if(t===1){ ctx.fillStyle='rgba(0,0,0,.12)'; ctx.fillRect(x,y+TILE-3,TILE,3); }
}
function drawMap(camX,camY){
  const startX = Math.floor(camX/TILE), startY = Math.floor(camY/TILE);
  for(let j=0;j<VH+2;j++){
    for(let i=0;i<VW+2;i++){
      const tx = startX+i, ty=startY+j;
      const t = (tx>=0&&ty>=0&&tx<MAP_W&&ty<MAP_H)? map[ty][tx] : 3;
      drawTile(t, i*TILE-(camX%TILE), j*TILE-(camY%TILE));
    }
  }
  // åœ°æ¨™æ¨™ç±¤ + åœ–ç¤º
  ctx.font='12px monospace';
  poi.forEach(p=>{
    const sx = p.x*TILE - camX, sy = p.y*TILE - camY;
    ctx.fillStyle='#fff';
    ctx.fillRect(sx-28, sy-28, 80, 16);
    ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.strokeRect(sx-28, sy-28, 80, 16);
    ctx.fillStyle='#111'; ctx.fillText(p.name.slice(0,8), sx-24, sy-16);
    ctx.font='18px serif'; ctx.fillText('ğŸ“', sx-8, sy+6);
  });
}
function drawPlayer(camX, camY) {
  // é¸æ“‡æ­£ç¢ºçš„ç²¾éˆåœ–
  const spriteImg = sprites[player.dir];
  
  // è™•ç†åœ–ç‰‡æœªè¼‰å…¥æƒ…æ³
  if (!spriteImg || !spriteImg.complete) {
    // åœ–ç‰‡æœªè¼‰å…¥æ™‚é¡¯ç¤ºå ä½ç¬¦
    ctx.font='22px serif';
    ctx.fillStyle = '#fff';
    ctx.fillText('ğŸ§‘â€ğŸ’»', Math.floor(player.x - camX - 10), Math.floor(player.y - camY + 8));
    return;
  }
  
  // æ¯å€‹æ–¹å‘æœ‰4å¹€ï¼Œæ¯å¹€32x32åƒç´ 
  const frameWidth = spriteImg.width / 4;
  const frameHeight = spriteImg.height;
  
  // æ ¹æ“šå‹•ç•«å¹€ç¹ªè£½æ­£ç¢ºçš„ç²¾éˆéƒ¨åˆ†
  ctx.drawImage(
    spriteImg,
    player.f * frameWidth, 0, frameWidth, frameHeight,
    Math.floor(player.x - camX - 16), Math.floor(player.y - camY - 16),
    32, 32
  );
}

// äº®è‰²é“è·¯é€£ç·šï¼ˆå¯è¦–åŒ–è·¯å¾‘ï¼‰
function drawRoads(camX,camY){
  ctx.save();
  ctx.translate(-camX, -camY);
  ctx.lineWidth = 5;
  ctx.strokeStyle = 'rgba(255,255,255,.9)';
  ctx.lineCap='round'; ctx.lineJoin='round';
  ctx.beginPath();
  const order = ['it','vpn','dev','cafeteria','clinic','hr'];
  for(let i=0;i<order.length-1;i++){
    const a = poi.find(p=>p.id===order[i]);
    const b = poi.find(p=>p.id===order[i+1]);
    ctx.moveTo(a.x*TILE, a.y*TILE);
    ctx.lineTo(b.x*TILE, b.y*TILE);
  }
  ctx.stroke();
  ctx.restore();
}

// èµ·é»/çµ‚é» + è„ˆå‹•å…‰åœˆ
function drawStartEnd(camX, camY){
  ctx.save();
  ctx.translate(-camX, -camY);
  const pulse = (Math.sin(performance.now()/400)+1)/2;  // 0~1
  function ring(x, y, color){
    const gx = x*TILE, gy = y*TILE;
    const r  = 18 + 6*pulse;
    const g = ctx.createRadialGradient(gx, gy, 0, gx, gy, r);
    g.addColorStop(0, color);
    g.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.fillStyle = g;
    ctx.beginPath(); ctx.arc(gx, gy, r, 0, Math.PI*2); ctx.fill();
  }
  ring(START.x, START.y, 'rgba(16,185,129,.35)'); // ç¶ 
  ring(END.x,   END.y,   'rgba(245,158,11,.35)'); // é‡‘

  ctx.font='18px serif';
  ctx.fillText('ğŸš©', START.x*TILE-8, START.y*TILE+6);
  ctx.fillText('ğŸ†', END.x*TILE-8,   END.y*TILE+6);

  //ctx.font='12px monospace';
  //ctx.fillStyle='#fff';
  //ctx.fillRect(START.x*TILE-22, START.y*TILE-28, 40, 16);
  //ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.strokeRect(START.x*TILE-22, START.y*TILE-28, 40, 16);
  //ctx.fillStyle='#111'; ctx.fillText('èµ·é»', START.x*TILE-14, START.y*TILE-16);

  ctx.fillStyle='#fff';
  ctx.fillRect(END.x*TILE-22, END.y*TILE-28, 40, 16);
  ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.strokeRect(END.x*TILE-22, END.y*TILE-28, 40, 16);
  ctx.fillStyle='#111'; ctx.fillText('çµ‚é»', END.x*TILE-14, END.y*TILE-16);
  ctx.restore();
}

/* ================= å°åœ°åœ– ================= */
function drawMiniMap(camX, camY){
  const w=120,h=90, x=18, y=18, pad=6;
  ctx.save();
  ctx.globalAlpha=.95;
  ctx.fillStyle='#111'; ctx.fillRect(x-2, y-2, w+4, h+4);
  ctx.fillStyle='#fff'; ctx.fillRect(x, y, w, h);
  const scaleX = w/(MAP_W*TILE), scaleY=h/(MAP_H*TILE);

  // ç“¦ç‰‡ï¼ˆåªç•«ç°¡åŒ–è‰²ï¼‰
  for(let ty=0;ty<MAP_H;ty++){
    for(let tx=0;tx<MAP_W;tx++){
      const t=map[ty][tx];
      if(t===3) ctx.fillStyle='#a5b4fc';
      else if(t===2) ctx.fillStyle='#9ca3af';
      else if(t===1) ctx.fillStyle='#d6b891';
      else ctx.fillStyle='#c7f0d8';
      ctx.fillRect(x+tx*TILE*scaleX, y+ty*TILE*scaleY, TILE*scaleX, TILE*scaleY);
    }
  }

  // POI
  ctx.fillStyle='#ef4444';
  poi.forEach(p=>{
    ctx.fillRect(x+p.x*TILE*scaleX-2, y+p.y*TILE*scaleY-2, 4,4);
  });

  // Start / End
  ctx.fillStyle='#10b981';
  ctx.fillRect(x+START.x*TILE*scaleX-2, y+START.y*TILE*scaleY-2, 4,4);
  ctx.fillStyle='#f59e0b';
  ctx.fillRect(x+END.x*TILE*scaleX-2, y+END.y*TILE*scaleY-2, 4,4);

  // è¦–å£æ¡†
  ctx.strokeStyle='#000';
  ctx.lineWidth=1;
  ctx.strokeRect(x+camX*scaleX, y+camY*scaleY, W*scaleX, H*scaleY);

  // ç©å®¶
  ctx.fillStyle='#0ea5e9';
  ctx.fillRect(x+player.x*scaleX-2, y+player.y*scaleY-2, 4,4);
  ctx.restore();
}

/* ================= æ—¥å¤œå¾ªç’°ï¼ˆå¯åˆ‡æ›ï¼‰ ================= */
let ENABLE_DAYNIGHT = false;  // é è¨­é—œé–‰ï¼ŒæŒ‰ N åˆ‡æ›
let tClock = 0, DAY_SPEED = 0.015;
addEventListener('keydown', e=>{
  if(e.key==='n' || e.key==='N') ENABLE_DAYNIGHT = !ENABLE_DAYNIGHT;
  if(e.key==='r' || e.key==='R'){ player.x = START.x*TILE+16; player.y = START.y*TILE+16; }
});
function drawDayNight(){
  if(!ENABLE_DAYNIGHT) return;
  tClock += DAY_SPEED;
  const k=(Math.sin(tClock)+1)/2;       // 0~1
  const darkness = 0.10 + 0.20*k;      // æ·¡ä¸€é»
  ctx.fillStyle=`rgba(0,0,20,${darkness})`;
  ctx.fillRect(0,0,W,H);
}

/* ================= å°è©± & ç…§ç‰‡ ================= */
const dlgBox = document.getElementById('dlg');
function say(lines){ // é€å¥ Enter
  let i=0; dlgBox.style.display='block';
  function render(){ dlgBox.innerHTML = lines[i] + 'ã€€<span class="k">Enter</span> ä¸‹ä¸€å¥';
    const handler = (e)=>{ if(e.key==='Enter'){ i++; if(i>=lines.length){ dlgBox.style.display='none'; removeEventListener('keydown',handler);} else render(); } }
    addEventListener('keydown',handler,{once:true});
  } render();
}
const ph = { modal:document.getElementById('photo'), title:document.getElementById('phTitle'),
             img:document.getElementById('phImg'), desc:document.getElementById('phDesc') };
function openPhoto(p){ ph.title.textContent=p.name; ph.img.src=p.photo||''; ph.desc.textContent=p.desc||''; ph.modal.classList.add('active'); }
function closePhoto(){ ph.modal.classList.remove('active'); }

/* ================= äº’å‹• ================= */
const hint = document.getElementById('hint');
function checkPOI(){
  for(const p of poi){
    const dx = Math.abs(player.x/TILE - p.x), dy = Math.abs(player.y/TILE - p.y);
    if(dx<0.8 && dy<0.8){
      hint.innerHTML = `<b>${p.name}</b>ã€€æŒ‰ <b>E</b> æŸ¥çœ‹ / <b>Enter</b> å°è©±`;
      if(keys['e']||keys['E']){ keys['e']=keys['E']=false; openPhoto(p); }
      if(keys['Enter']){ keys['Enter']=false; say(p.talk); }
      const q = quests.find(q=>q.id===p.id); if(q && !q.done){ q.done=true; drawQuests(); }
      if(p.next) hint.innerHTML += `<div class="hint-muted" style="margin-top:4px">${p.next}</div>`;
      return;
    }
  }
  hint.textContent = 'åœ¨åœ’å€å…§èµ°å‹•ï¼Œé è¿‘åœ°æ¨™å¯äº’å‹•ã€‚';
}

/* ================= ä¸»è¿´åœˆ ================= */
function loop(){
  // æ¨™è¨˜ç©å®¶ç‚ºéç§»å‹•ç‹€æ…‹ï¼Œç„¶å¾Œæª¢æŸ¥æŒ‰éµ
  player.moving = false;
  
  // æ§åˆ¶
  if(keys['ArrowUp']||keys['w'])    move(0,-SPEED,'up');
  if(keys['ArrowDown']||keys['s'])  move(0, SPEED,'down');
  if(keys['ArrowLeft']||keys['a'])  move(-SPEED,0,'left');
  if(keys['ArrowRight']||keys['d']) move( SPEED,0,'right');

  // å¦‚æœç©å®¶æ²’æœ‰ç§»å‹•ï¼Œé‡ç½®åˆ°ç¬¬ä¸€å¹€
  if(!player.moving && player.f !== 0) {
    player.f = 0;
  }

  // é¡é ­è·Ÿéš¨
  camX = Math.min(Math.max(0, player.x - W/2), MAP_W*TILE - W);
  camY = Math.min(Math.max(0, player.y - H/2), MAP_H*TILE - H);

  // ç¹ªè£½
  ctx.clearRect(0,0,W,H);
  drawMap(camX,camY);
  drawRoads(camX,camY);
  drawStartEnd(camX,camY);
  drawPlayer(camX,camY);
  drawDayNight();
  drawMiniMap(camX,camY);
  checkPOI();

  requestAnimationFrame(loop);
}
loop();

function move(dx, dy, dir) {
  player.dir = dir;
  player.moving = true;
  
  // åªåœ¨ç§»å‹•æ™‚æ›´æ–°å‹•ç•«
  player.tick = (player.tick + 1) % 10;
  if (player.tick === 0) {
    player.f = (player.f + 1) % 4; // 4å¹€å‹•ç•«
  }
  
  const nx = player.x + dx, ny = player.y + dy;
  const px = nx-12, py = ny-12, pw=24, ph=24;
  const corners = [
    [Math.floor(px/TILE), Math.floor(py/TILE)],
    [Math.floor((px+pw)/TILE), Math.floor(py/TILE)],
    [Math.floor(px/TILE), Math.floor((py+ph)/TILE)],
    [Math.floor((px+pw)/TILE), Math.floor((py+ph)/TILE)],
  ];
  
  if (!corners.some(([tx,ty]) => isBlocked(tx,ty))) {
    player.x = nx; 
    player.y = ny;
  }
}
</script>
</body>
</html>